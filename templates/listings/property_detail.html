{% extends "listings/base.html" %}
{% load static humanize %}

{% block title %}
{{ obj.title }} | Kam Luxury Nigeria
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    
    <!-- MAIN COLUMN -->
    <div class="col-lg-8">

      <!-- Image carousel -->
      <div id="propertyCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner">
          {% if images %}
            {% for img_url in images %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img src="{{ img_url }}" class="d-block w-100 rounded" alt="{{ obj.title }}" loading="lazy">
              </div>
            {% endfor %}
          {% else %}
            <div class="carousel-item active">
              <img src="{% static 'img/default_property.jpg' %}" class="d-block w-100 rounded" alt="No image available">
            </div>
          {% endif %}
        </div>

        {% if images|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        {% endif %}
      </div>

      <!-- Thumbnails -->
      <div class="row gx-2 gy-2 mb-4">
        {% if images %}
          {% for img_url in images %}
            <div class="col-4 col-md-3">
              <a href="#" data-bs-target="#propertyCarousel" data-bs-slide-to="{{ forloop.counter0 }}">
                <img src="{{ img_url }}" class="img-fluid rounded shadow-sm" alt="thumb {{ forloop.counter }}">
              </a>
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <!-- Unit Options -->
      {% with obj.options.all as options %}
        {% if options %}
          <h4 class="h6 mb-3">Unit Options</h4>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Type</th>
                  <th>Label</th>
                  <th class="text-end">Price</th>
                  <th class="text-end">Initial Deposit</th>
                </tr>
              </thead>
              <tbody>
                {% for opt in options %}
                  <tr>
                    <td>{{ opt.get_unit_type_display }}</td>
                    <td>{{ opt.label }}</td>
                    <td class="text-end">₦{{ opt.price|floatformat:0|intcomma }}</td>
                    <td class="text-end">
                      {% if opt.initial_deposit %}
                        ₦{{ opt.initial_deposit|floatformat:0|intcomma }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% endwith %}

      <!-- Property Title & Key Facts -->
      <h1 class="h3 mb-2">{{ obj.title }}</h1>
      <p class="text-muted mb-3">
        {{ obj.get_category_display }} — {{ obj.location }}
        {% if obj.price %} • <strong>₦{{ obj.price|floatformat:0|intcomma }}</strong>{% endif %}
      </p>

      <!-- Description -->
      <div class="mb-4">
        {{ obj.description|linebreaks }}
      </div>

      <!-- Additional Key Facts -->
      <ul class="list-unstyled mb-4">
        {% if obj.bedrooms %}<li><strong>Bedrooms:</strong> {{ obj.bedrooms }}</li>{% endif %}
        {% if obj.bathrooms %}<li><strong>Bathrooms:</strong> {{ obj.bathrooms }}</li>{% endif %}
        {% if obj.parking %}<li><strong>Parking:</strong> {{ obj.parking }}</li>{% endif %}
        {% if obj.square_meters %}<li><strong>Size:</strong> {{ obj.square_meters }} m²</li>{% endif %}
        {% if obj.installment_plan %}<li><strong>Installment plan:</strong> {{ obj.installment_plan }}</li>{% endif %}
      </ul>

    </div>

    <!-- SIDEBAR -->
    <aside class="col-lg-4">
      <!-- Contact Form -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">Contact Us</h5>
          <form method="post" action="{% url 'listings:contact_us' obj.id %}">
            {% csrf_token %}
            <input type="hidden" name="property" value="{{ obj.id }}">
            <div class="mb-3">
              <label for="id_name" class="form-label">Name</label>
              <input id="id_name" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="id_email" class="form-label">Email</label>
              <input id="id_email" name="email" type="email" class="form-control">
            </div>
            <div class="mb-3">
              <label for="id_phone" class="form-label">Phone</label>
              <input id="id_phone" name="phone" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="id_message" class="form-label">Message</label>
              <textarea id="id_message" name="message" rows="4" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">Send Enquiry</button>
          </form>
          <hr class="my-3">
          <p class="mb-0 small text-muted">
            Or contact us on WhatsApp:
            <a href="{{ whatsapp_link|default:'#' }}" target="_blank" rel="noopener">Open chat</a>
          </p>
        </div>
      </div>

      <!-- Quick Facts Card -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="mb-2">Listing details</h6>
          <p class="mb-1"><strong>Posted:</strong> {{ obj.created_at|date:"F j, Y" }}</p>
          {% if obj.initial_deposit %}<p class="mb-1"><strong>Initial deposit:</strong> ₦{{ obj.initial_deposit|floatformat:0|intcomma }}</p>{% endif %}
          {% if obj.price %}<p class="mb-1"><strong>Price:</strong> ₦{{ obj.price|floatformat:0|intcomma }}</p>{% endif %}
        </div>
      </div>
    </aside>

  </div>
</div>

<style>
.carousel-item img { max-height: 560px; object-fit: cover; width: 100%; }
.row.gx-2 img { height: 90px; object-fit: cover; }
.table-responsive { overflow-x: auto; }
</style>
{% endblock %}
